#!/groovy
@Library('cx-jenkins-pipeline-kit') _
import java.time.*

def workspace
def vmName = "${BUILD_TAG}-CxSAST"
def vmTemplate89 = "CxSDLC-Template-CxSAST-8-9"
def vmTemplate90 = "CxSDLC-Template-CxSAST-9-0"
def ipAddress89
def ipAddress90
def ram = "12000"
def cpu = "4"
def provider = "VMWARE"
def decommissionPeriod = "3 hour"
def vmwareNetwork = "Lab"
def automationBranch = "9.0.0"

def performParallelStages(String sastVer, String sastIP, String jenkinsVer) {
    workspace = pwd()
    def dockerHostIP = sh(returnStdout: true, script: "hostname -I | awk '{print \$1}'").trim()
    def jenkinsContainerName = "deploy-jenkins-${jenkinsVer}-sast-${sastVer}-${BUILD_TAG}"
    def jenkinsContainerPort

    stage("Deploy Jenkins-${jenkinsVer} for CxSAST-${sastVer}") {
        echo "Deploying Jenkins-${jenkinsVer} for CxSAST-${sastVer}"
        sh "mkdir -p ${workspace}/jenkins-${jenkinsVer}/sast-${sastVer}/jenkins_home"
        sh "cp -R /var/jenkins/workspace/jenkins-${jenkinsVer}/* ${workspace}/jenkins-${jenkinsVer}/sast-${sastVer}/jenkins_home"
        //sh "cp -a /var/jenkins/workspace/jenkins-${jenkinsVer}/. ${workspace}/jenkins-${jenkinsVer}/sast-${sastVer}/jenkins_home/"
        sh "cp build/libs/checkmarx.hpi ${workspace}/jenkins-${jenkinsVer}/sast-${sastVer}/jenkins_home/plugins"
        sh "chmod -R 777 ${workspace}/jenkins-${jenkinsVer}/sast-${sastVer}/jenkins_home"
        sh "docker run --rm --privileged -d -P --name ${jenkinsContainerName} -v ${workspace}/jenkins-${jenkinsVer}/sast-${sastVer}/jenkins_home:/var/jenkins_home jenkins/jenkins:${jenkinsVer}"
        jenkinsContainerPort = sh(returnStdout: true, script: "docker port ${jenkinsContainerName} 8080").substring(8).trim()
        //all the next rows not necessarily needed! check after automation will pass
        sh "cp /var/jenkins/workspace/jenkins.model.JenkinsLocationConfiguration.xml ${workspace}/jenkins-${jenkinsVer}/sast-${sastVer}/jenkins_home"
        sh "sed -e 's/CxJenkinsIP/${dockerHostIP}/g' -i ${workspace}/jenkins-${jenkinsVer}/sast-${sastVer}/jenkins_home/jenkins.model.JenkinsLocationConfiguration.xml"
        sh "sed -e 's/CxJenkinsPort/${jenkinsContainerPort}/g' -i ${workspace}/jenkins-${jenkinsVer}/sast-${sastVer}/jenkins_home/jenkins.model.JenkinsLocationConfiguration.xml"
        sleep 10
        sh "curl -O http://${dockerHostIP}:${jenkinsContainerPort}/jnlpJars/jenkins-cli.jar"
        sh "java -jar jenkins-cli.jar -s http://${dockerHostIP}:${jenkinsContainerPort} -auth admin:admin reload-configuration"
        //sh "cat ${workspace}/jenkins-${jenkinsVer}/sast-${sastVer}/jenkins_home/jenkins.model.JenkinsLocationConfiguration.xml"
    }

    try {
        stage("Pull Automation for Jenkins-${jenkinsVer}-CxSAST-${sastVer}") {
            echo "Pulling automation code for Jenkins-${jenkinsVer}-CxSAST-${sastVer}"

            dir("${workspace}/jenkins-${jenkinsVer}/sast-${sastVer}/Checkmarx-Plugin-System-Test") {
                git branch: automationBranch, credentialsId: '15f8e7b7-6ce7-44c0-b151-84f99ffa7aed', poll: false, url: 'http://tfs2013:8080/tfs/DefaultCollection/Automation/_git/Checkmarx-Plugin-System-Test'
                sh "cp -r /var/jenkins/workspace/env ."
                sh "sed -e 's/<CxSastIpAddress>/${sastIP}/g' -i ./env/topology.xml"
                sh "sed -e 's/<CxJenkinsIp>/${dockerHostIP}/g' -i ./env/topology.xml"
                sh "sed -e 's/<CxJenkinsPort>/${jenkinsContainerPort}/g' -i ./env/topology.xml"
                sh "sed -e 's/<CxJenkinsIp>/${dockerHostIP}/g' -i ./env/env.properties"
                sh "sed -e 's/<CxJenkinsPort>/${jenkinsContainerPort}/g' -i ./env/env.properties"
                //sh "cat ./env/topology.xml"
                //sh "cat ./env/env.properties"
            }
        }

        stage("Run Problematic Global tests for Jenkins-${jenkinsVer}-CxSAST-${sastVer}") {
            echo "Running Problematic Global tests for Jenkins-${jenkinsVer}-CxSAST-${sastVer}"
            sh "docker run --rm --privileged --name problematic-tests-jenkins-${jenkinsVer}-sast-${sastVer}-${BUILD_TAG} -v maven-repo:/root/.m2 -v ${workspace}/jenkins-${jenkinsVer}/sast-${sastVer}/Checkmarx-Plugin-System-Test:/usr/src/automation -v ${workspace}/jenkins-${jenkinsVer}/sast-${sastVer}/Checkmarx-Plugin-System-Test/env/chromedriver:/usr/local/bin/chromedriver -w /usr/src/automation maven:3.6.1-jdk-8-alpine \
            mvn -q clean test -Dtest=com.cx.automation.plugin.jenkins.sca.problematicGlobal.tests.**.* -Dtopology.xml.ref=/usr/src/automation/env/topology.xml -Denv=hardening_env -DfailIfNoTests=false -Dmaven.test.failure.ignore=false -DskipTests=false -Ddriver.browser=CHROME -Dheadless=true surefire-report:report"
        }
    } catch (e) {
        throw e
    } finally {
        //sh "docker logs ${jenkinsContainerName}"
        sh "docker logs ${jenkinsContainerName} &> deploy-jenkins-${jenkinsVer}-sast-${sastVer}.log"
        sh "docker stop ${jenkinsContainerName}"
        sh "cp ${workspace}/jenkins-${jenkinsVer}/sast-${sastVer}/Checkmarx-Plugin-System-Test/cxBaseDataModelAuto.log ./problematic-tests-jenkins-${jenkinsVer}-sast-${sastVer}.log"
        junit "jenkins-${jenkinsVer}/sast-${sastVer}/Checkmarx-Plugin-System-Test/JenkinsTests/target/surefire-reports/TEST-*.xml"
    }
}

pipeline {
    parameters {
        string(name: 'sastVersions', defaultValue: '8.9,9.0,9.2', description: 'Nodes to build, deploy and test')
        string(name: 'jenkinsVersions', defaultValue: 'jenkins01,jenkins02', description: 'App names')
        string(name: "vmTemplate89",defaultValue: "${vmTemplate89}", description: "Template for 8.9 VM")
        string(name: "vmTemplate90",defaultValue: "${vmTemplate90}", description: "Template for 9.0 VM")
        string(name: "ram",defaultValue: "${ram}", description: "Server memory")
        string(name: "cpu",defaultValue: "${cpu}", description: "")
        string(name: "provider",defaultValue: "${provider}", description: "IAAS platform to be used")
        string(name: "decommissionPeriod",defaultValue: "${decommissionPeriod}", description: "Decommission period")
        string(name: "vmwareNetwork",defaultValue: "${vmwareNetwork}", description: "vmware network for new VMs")
        choice(name: 'automationBranch', choices: ['9.0.0', 'cd-add-resources'], description: 'automation branch')
    }
    agent { node { label 'CxSDLC-Slave-CxJenkinsPlugin' } }
    options {
        timestamps()
        timeout(time: 2, unit: 'HOURS')
        //skipDefaultCheckout()
    }
    stages {

        stage('Pipeline Info') {
            steps {
                script {
                    env.PIPELINE_STATUS = "Success"
                    env.STAGE_NAME_FAILED = "None"
                    workspace = pwd()
                    sh 'printenv'
                }
            }
        }

        stage('Build') {
            steps {
                script {
                    sh "docker run --rm --name build-${BUILD_TAG} -v ${workspace}:/usr/src/cx-jenkins -v /root/.gradle:/root/.gradle -w /usr/src/cx-jenkins maven:3.6.1-jdk-8-alpine ./gradlew -x test clean jpi"
                }
            }
            post {
                failure {
                    script {
                        env.PIPELINE_STATUS = "Failure"
                        env.STAGE_NAME_FAILED = "${STAGE_NAME}"
                    }
                }
            }
        }

        stage('Unit Tests') {
            steps {
                script {
                    sh "docker run --rm --name test-${BUILD_TAG} -v ${workspace}:/usr/src/cx-jenkins -v /root/.gradle:/root/.gradle -w /usr/src/cx-jenkins maven:3.6.1-jdk-8-alpine ./gradlew test"
                }
            }
            post {
                failure {
                    script {
                        env.PIPELINE_STATUS = "Failure"
                        env.STAGE_NAME_FAILED = "${STAGE_NAME}"
                    }
                }
            }
        }

        stage('Create CxSAST VM') {
            when {
                expression {
                    BRANCH_NAME == 'master' || BRANCH_NAME.startsWith("PR-") && CHANGE_TARGET == 'master' || BRANCH_NAME == 'add-ci-cd'
                }
            }
            parallel {
                /*stage('8.9') {
                    steps {
                        script {
                            kit.Create_Vm_Terraform(vmName + "-8.9", vmTemplate89, ram, cpu, provider, decommissionPeriod, "Auto", "Plugins-CI", vmwareNetwork)
                            ipAddress89 = kit.getIpAddress(vmName + "-8.9", provider)
                            node('install01') {
                                kit.Create_Jenkins_Slave_On_Master(vmName + "-8.9")
                                kit.Start_Jenkins_Slave_On_Windows_Pstools(ipAddress89, vmName + "-8.9")
                            }
                        }
                    }
                }*/
                stage('9.0') {
                    steps {
                        script {
                            kit.Create_Vm_Terraform(vmName + "-9.0", vmTemplate90, ram, cpu, provider, decommissionPeriod, "Auto", "Plugins-CI", vmwareNetwork)
                            ipAddress90 = kit.getIpAddress(vmName + "-9.0", provider)
                            node('install01') {
                                kit.Create_Jenkins_Slave_On_Master(vmName + "-9.0")
                                kit.Start_Jenkins_Slave_On_Windows_Pstools(ipAddress90, vmName + "-9.0")
                            }
                        }
                    }
                }
            }
        }

        stage('System Tests') {
            when {
                expression {
                    BRANCH_NAME == 'master' || BRANCH_NAME.startsWith("PR-") && CHANGE_TARGET == 'master' || BRANCH_NAME == 'add-ci-cd'
                }
            }
            steps {
                script {
                    /*def sasts = [:]
                    for (sast in params.sastVersions.tokenize(',')) {
                        def jenkinses = [:]
                        sasts[sast] = {
                            for (jenkins in params.jenkinsVersions.tokenize(',')) {
                                jenkinses[jenkins] = { performParallelStages(sast, jenkins) }
                            }
                        }
                        parallel jenkinses
                    }
                    parallel sasts*/
                    /*def myStages = [performParallelStages("sast1", "jenkins1"),performParallelStages("sast2", "jenkins2")]
                    parallel myStages*/
                    def parallelTopLevelSteps = [:]

                    /*parallelTopLevelSteps['8.9'] = {
                        def parallelNestedSteps = [:]

                        parallelNestedSteps['8.9-lts-jdk8'] = { performParallelStages("8.9", ipAddress89,"lts") }
                        parallelNestedSteps['8.9-lts-jdk11'] = { performParallelStages("8.9", ipAddress89,"lts-jdk11") }

                        parallel(parallelNestedSteps)
                    }*/

                    parallelTopLevelSteps['9.0'] = {
                        def parallelNestedSteps = [:]

                        parallelNestedSteps['9.0-lts-jdk8'] = { performParallelStages("9.0", ipAddress90,"lts") }
                        //parallelNestedSteps['9.0-lts-jdk11'] = { performParallelStages("9.0", ipAddress90,"lts-jdk11") }

                        parallel(parallelNestedSteps)
                    }

                    parallel(parallelTopLevelSteps)
                }
            }
        }

        /*stage('Jenkins Instance') {
            parallel {

                stage('Java 8') {
                    stages {
                        stage('Stage 1') {
                            steps {
                                script {
                                    echo "Stage 1"
                                }
                            }
                        }
                        stage('Stage 2') {
                            steps {
                                script {
                                    echo "Stage 2"
                                }
                            }
                        }
                    }
                }

                stage('Java 11') {
                    stages {
                        stage('Stage 1') {
                            steps {
                                script {
                                    echo "Stage 1"
                                }
                            }
                        }
                        stage('Stage 2') {
                            steps {
                                script {
                                    echo "stage 2"
                                }
                            }
                        }
                    }
                }
            }
        }*/
    }
    
    post {
        always {
            archiveArtifacts "*.zip, build/libs/*.hpi, *.log"
            script {
                //dir("${workspace}/9.0/Checkmarx-System-Test") {
                //    junit '**/PluginsCommonClient/target/surefire-reports/**/*.xml'
                //}
                if (ipAddress89 != null) {
                    /*node(vmName + "-9.0") {
                                kit.zipStashInstallationLogs("CxSAST-9.0-Logs")
                            }
                            unstash "CxSAST-9.0-Logs"*/
                    deleteVm(provider, ipAddress89, vmName + "-8.9")
                }
                if (ipAddress90 != null) {
                    /*node(vmName + "-9.0") {
                                kit.zipStashInstallationLogs("CxSAST-9.0-Logs")
                            }
                            unstash "CxSAST-9.0-Logs"*/
                    deleteVm(provider, ipAddress90, vmName + "-9.0")
                }
                /*try {
                    kit.Command_Execution_Sh("jq -n env > env.json")
                    kit.Command_Execution_Sh("curl -sb -k -v -H \"Content-type: application/json\" -XPOST http://cx-elastic01:9200/cx-client-common/_doc -d @env.json")
                } catch (Exception e) {
                    kit.Warning_Msg("The message couldn't be pushed to elastic, error:\n" + e.toString())
                }*/
            }
        }
        cleanup {
            cleanWs()
        }
    }
}
